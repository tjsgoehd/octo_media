<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>옥튜브 - 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; letter-spacing: -0.025em; }
        
        .video-card { background: white; border-radius: 16px; overflow: hidden; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); cursor: pointer; border: 1px solid #f1f5f9; position: relative; }
        .video-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: #e2e8f0; }
        
        .author-badge {
            position: absolute; top: 10px; left: 10px; background-color: #ff5a5a; color: white;
            padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 700; z-index: 10; box-shadow: 0 4px 8px rgba(255, 90, 90, 0.3);
        }

        .category-text { color: #2563eb; font-size: 11px; font-weight: 700; margin-bottom: 2px; display: inline-block; }
        .video-title { font-size: 1rem; font-weight: 800; color: #0f172a; line-height: 1.3; }

        .filter-btn { transition: all 0.2s; background: white; color: #64748b; border: 1px solid #f1f5f9; white-space: nowrap; }
        .filter-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        #admin-modal { backdrop-filter: blur(20px); background-color: rgba(0, 0, 0, 0.85); }
        
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2.5 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                    <i data-lucide="play" fill="white" class="w-4 h-4 ml-0.5"></i>
                </div>
                <span class="font-extrabold text-xl tracking-tighter">옥튜브</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="handleLogout()" class="admin-only bg-rose-50 text-rose-600 px-4 py-2 rounded-full text-xs font-bold border border-rose-100 hover:bg-rose-100 transition-all">로그아웃</button>
                <button id="login-btn" onclick="initGoogleAuth()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-200 transition-all">관리자 로그인</button>
                <!-- 영상 등록 버튼: 기존 기능을 방해하던 alert 제거 -->
                <button onclick="triggerOriginalUpload()" class="admin-only bg-blue-600 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-lg hover:bg-blue-700 transition-all">영상 등록</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- 카테고리 필터 (가이드 추가됨) -->
        <div id="category-filters" class="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
            <button onclick="filterVideos('전체')" class="filter-btn active px-6 py-2.5 rounded-full text-sm font-bold">전체</button>
            <button onclick="filterVideos('단기컷')" class="filter-btn px-6 py-2.5 rounded-full text-sm font-bold">단기컷</button>
            <button onclick="filterVideos('공략')" class="filter-btn px-6 py-2.5 rounded-full text-sm font-bold">공략</button>
            <button onclick="filterVideos('가이드')" class="filter-btn px-6 py-2.5 rounded-full text-sm font-bold">가이드</button>
            <button onclick="filterVideos('기타')" class="filter-btn px-6 py-2.5 rounded-full text-sm font-bold">기타</button>
        </div>

        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mt-4">
            <!-- 데이터 로딩 중 표시 -->
            <div class="col-span-full py-20 text-center text-slate-400">영상을 불러오고 있습니다...</div>
        </div>
    </main>

    <!-- 수정 모달 (관리자용) -->
    <div id="admin-modal" class="fixed inset-0 z-[1100] hidden flex-col items-center justify-center p-4" onclick="closeAdminModal()">
        <div class="bg-white rounded-[32px] w-full max-w-xl p-8 overflow-hidden relative shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">영상 정보 수정</h2>
                <button onclick="closeAdminModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-400 ml-1">영상 제목</label>
                    <input type="text" id="input-title" class="w-full p-4 bg-slate-50 rounded-xl border-none outline-none focus:ring-2 ring-blue-100">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 ml-1">카테고리</label>
                        <select id="input-category" class="w-full p-4 bg-slate-50 rounded-xl border-none">
                            <option value="단기컷">단기컷</option>
                            <option value="공략">공략</option>
                            <option value="가이드">가이드</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 ml-1">작성자</label>
                        <input type="text" id="input-author" class="w-full p-4 bg-slate-50 rounded-xl border-none">
                    </div>
                </div>
                <button id="save-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 hover:bg-blue-700 transition-all">수정 완료</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const videoCollection = collection(db, 'artifacts', 'octopath-85851', 'public', 'data', 'videos');

        let allVideos = [];
        let currentFilter = '전체';

        window.onload = async () => {
            onAuthStateChanged(auth, (user) => {
                if (!user) signInAnonymously(auth);
            });

            if (sessionStorage.getItem('drive_token')) {
                document.body.classList.add('is-admin');
                document.getElementById('login-btn').style.display = 'none';
            }

            loadVideos();
            lucide.createIcons();
        };

        function loadVideos() {
            onSnapshot(videoCollection, (snap) => {
                allVideos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderVideos();
            });
        }

        window.renderVideos = () => {
            const grid = document.getElementById('video-grid');
            const filtered = currentFilter === '전체' ? allVideos : allVideos.filter(v => v.category === currentFilter);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400">해당 카테고리의 영상이 없습니다.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(v => `
                <div class="video-card" onclick="window.openPlayer ? openPlayer('${v.id}') : console.log('Player not found')">
                    <div class="aspect-video bg-slate-200 relative">
                        <div class="author-badge">
                            <i data-lucide="user" class="w-2.5 h-2.5"></i>
                            <span>${v.author || 'GetStar'}</span>
                        </div>
                        <img src="${v.thumbnail}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400x225?text=No+Thumbnail'">
                    </div>
                    <div class="p-3 md:p-4">
                        <span class="category-text">${v.category}</span>
                        <h3 class="video-title line-clamp-2">${v.title}</h3>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.filterVideos = (cat) => {
            currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === cat);
            });
            renderVideos();
        };

        // 영상 등록 버튼 클릭 시 기존 업로드 로직을 방해 없이 실행
        window.triggerOriginalUpload = () => {
            // 1. 기존 업로드 모달 함수가 있다면 실행
            if (window.openUploadModal) {
                window.openUploadModal();
            } 
            // 2. 만약 별도의 업로드 페이지가 있다면 이동 (파일명을 확인해 보세요)
            else {
                // 기존 업로드 로직이 있는 파일로 이동시키거나 함수를 호출하세요.
                // 예: location.href = 'upload.html';
                console.log("기존 업로드 함수를 찾을 수 없습니다. 원본 코드의 업로드 함수명을 확인해 주세요.");
                // 임시: 기존에 잘 되던 코드가 로컬 파일이라면 아래 주석을 해제해 보세요.
                // location.href = 'upload.html'; 
            }
        };

        window.closeAdminModal = () => document.getElementById('admin-modal').classList.add('hidden');
        window.handleLogout = () => { sessionStorage.removeItem('drive_token'); location.reload(); };
        window.initGoogleAuth = () => { sessionStorage.setItem('drive_token', 'active'); location.reload(); };
    </script>
</body>
</html>
