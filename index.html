<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>옥튜브 - 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; letter-spacing: -0.025em; }
        
        /* 영상 카드 레이아웃 */
        .video-card { background: white; border-radius: 16px; overflow: hidden; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); cursor: pointer; border: 1px solid #f1f5f9; position: relative; }
        .video-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: #e2e8f0; }
        
        /* 플로팅 배너 (작성자) */
        .author-badge {
            position: absolute; top: 10px; left: 10px; background-color: #ff5a5a; color: white;
            padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 700; z-index: 10; box-shadow: 0 4px 8px rgba(255, 90, 90, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 모바일 환경 배지 및 아이콘 정밀 수정 */
        @media (max-width: 768px) {
            .author-badge { 
                top: 8px; 
                left: 8px; 
                padding: 2px 6px; 
                font-size: 8px; 
                gap: 2px; 
            }
            .author-badge i { 
                width: 7px !important; 
                height: 7px !important; 
                stroke-width: 3.5px; 
            }
            .video-title { font-size: 0.85rem; line-height: 1.25; }
        }

        .category-text { color: #2563eb; font-size: 11px; font-weight: 700; margin-bottom: 2px; display: inline-block; }
        .video-title { font-size: 1rem; font-weight: 800; color: #0f172a; line-height: 1.3; }

        .filter-btn { transition: all 0.2s; background: white; color: #64748b; border: 1px solid #f1f5f9; }
        .filter-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }

        #player-modal { backdrop-filter: blur(20px); background-color: rgba(0, 0, 0, 0.9); }
        
        /* 관리자 전용 요소 제어 */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        body.is-admin #login-btn { display: none !important; }
    </style>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2.5 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                    <i data-lucide="play" fill="white" class="w-4 h-4 ml-0.5"></i>
                </div>
                <span class="font-extrabold text-xl tracking-tighter">옥튜브</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="handleLogout()" class="admin-only bg-rose-50 text-rose-600 px-3 py-2 rounded-full text-[11px] font-bold border border-rose-100">로그아웃</button>
                <button id="login-btn" onclick="initGoogleAuth(true)" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold">관리자 로그인</button>
                <button onclick="openAdmin()" class="admin-only bg-blue-600 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-lg">영상 등록</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="category-filters" class="flex gap-2 overflow-x-auto pb-6 mb-4">
            <button onclick="filterVideos('전체')" class="filter-btn active px-6 py-2 rounded-full text-sm font-bold">전체</button>
            <button onclick="filterVideos('단기컷')" class="filter-btn px-6 py-2 rounded-full text-sm font-bold">단기컷</button>
            <button onclick="filterVideos('공략')" class="filter-btn px-6 py-2 rounded-full text-sm font-bold">공략</button>
        </div>
        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
    </main>

    <!-- 플레이어 모달 -->
    <div id="player-modal" class="fixed inset-0 z-[1000] hidden flex-col items-center justify-center p-4" onclick="closePlayer()">
        <div class="w-full max-w-5xl" onclick="event.stopPropagation()">
            <div id="video-container" class="bg-black rounded-[24px] overflow-hidden aspect-video shadow-2xl relative"></div>
            <div class="mt-6 flex justify-center gap-3">
                <button onclick="closePlayer()" class="text-white bg-white/10 px-8 py-3 rounded-full font-bold backdrop-blur-md">닫기</button>
                <!-- 관리자에게만 노출되는 우회 버튼 -->
                <button id="direct-view-btn" class="admin-only text-blue-400 bg-blue-400/10 px-8 py-3 rounded-full font-bold backdrop-blur-md">원본 보기 (관리자용)</button>
            </div>
            <!-- 관리자용 안내 문구 -->
            <div class="admin-only mt-4 text-center text-slate-400 text-xs font-medium justify-center">
                * 인코딩 지연 시 위 '원본 보기' 버튼을 눌러 상태를 확인하세요.
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const targetCollection = collection(db, 'artifacts', 'octopath-85851', 'public', 'data', 'videos');

        let allVideos = [];

        window.onload = async () => {
            await signInAnonymously(auth);
            loadVideos();
            if(sessionStorage.getItem('drive_token')) {
                document.body.classList.add('is-admin');
            }
            lucide.createIcons();
        };

        function loadVideos() {
            onSnapshot(targetCollection, (snap) => {
                allVideos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                    .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderVideos();
            });
        }

        window.renderVideos = () => {
            const grid = document.getElementById('video-grid');
            if(!grid) return;
            grid.innerHTML = allVideos.map(v => `
                <div class="video-card" onclick="openPlayer('${v.fileId}')">
                    <div class="aspect-video bg-slate-100 relative">
                        <div class="author-badge">
                            <i data-lucide="user"></i>
                            <span>${v.author || '익명'}</span>
                        </div>
                        <img src="${v.thumbnail}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <span class="category-text">${v.category}</span>
                        <h3 class="video-title line-clamp-2">${v.title}</h3>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.openPlayer = (fileId) => {
            const container = document.getElementById('video-container');
            const directBtn = document.getElementById('direct-view-btn');
            
            container.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" class="w-full h-full" allow="autoplay"></iframe>`;
            
            // 관리자용 직접 링크 설정
            directBtn.onclick = () => window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
            
            document.getElementById('player-modal').classList.replace('hidden', 'flex');
        };

        window.closePlayer = () => {
            document.getElementById('video-container').innerHTML = '';
            document.getElementById('player-modal').classList.replace('flex', 'hidden');
        };

        window.handleLogout = () => {
            if(confirm("관리자 로그아웃 하시겠습니까?")) {
                sessionStorage.removeItem('drive_token');
                document.body.classList.remove('is-admin');
                location.reload();
            }
        };

        // 관리자 모달 및 구글 인증 (간략화된 예시)
        window.initGoogleAuth = () => {
            // 구글 로그인 팝업 로직은 기존 코드를 참조하여 여기에 위치
            // 현재는 시뮬레이션을 위해 토큰 세팅 후 관리자 모드 활성화로 가정
            alert("관리자 로그인을 진행합니다.");
            sessionStorage.setItem('drive_token', 'temp_token');
            document.body.classList.add('is-admin');
        };

        window.openAdmin = () => {
            alert("영상 등록 모달을 엽니다.");
            // 기존의 admin-modal 노출 로직 실행
        };

        window.filterVideos = (cat) => {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.innerText === cat);
            });
            // 필터링 로직 구현...
        };
    </script>
</body>
</html>
