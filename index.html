<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>옥튜브 - 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; letter-spacing: -0.025em; }
        
        /* 영상 카드 레이아웃 */
        .video-card { background: white; border-radius: 16px; overflow: hidden; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); cursor: pointer; border: 1px solid #f1f5f9; }
        .video-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: #e2e8f0; }
        
        /* 플로팅 배너 (작성자) - 데스크탑 기본 */
        .author-badge {
            position: absolute; top: 10px; left: 10px; background-color: #ff5a5a; color: white;
            padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 700; z-index: 10; box-shadow: 0 4px 8px rgba(255, 90, 90, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 영상 정보 텍스트 */
        .category-text { color: #2563eb; font-size: 11px; font-weight: 700; margin-bottom: 2px; display: inline-block; }
        .video-title { font-size: 1rem; font-weight: 800; color: #0f172a; line-height: 1.3; letter-spacing: -0.03em; }

        /* 모바일 환경 최적화 (768px 이하) */
        @media (max-width: 768px) {
            /* 플로팅 배너 위치 및 사이즈 정밀 조정 */
            .author-badge { 
                top: 8px; 
                left: 8px; 
                padding: 1.5px 5px; 
                font-size: 7.5px; 
                gap: 2px; 
            }
            /* 아이콘 크기를 텍스트에 맞춰 더 작게 조정 */
            .author-badge i { width: 6.5px !important; height: 6.5px !important; stroke-width: 3px; }
            
            /* 제목 텍스트 크기 축소 */
            .video-title { font-size: 0.85rem; line-height: 1.2; letter-spacing: -0.04em; }
            .category-text { font-size: 9px; }
            
            /* 카테고리 필터 버튼 */
            .filter-btn { padding-left: 0.85rem !important; padding-right: 0.85rem !important; font-size: 0.7rem !important; }
        }

        /* 필터 버튼 기본 스타일 */
        .filter-btn { transition: all 0.2s; background: white; color: #64748b; border: 1px solid #f1f5f9; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .filter-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }

        .thumb-option { border: 4px solid transparent; border-radius: 14px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .thumb-option.selected { border-color: #2563eb; transform: scale(1.05); z-index: 10; }
        
        #player-modal, #admin-modal, #loading-overlay { backdrop-filter: blur(20px); background-color: rgba(0, 0, 0, 0.85); }
        
        /* 관리자 전용 요소 제어 */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        body.is-admin .login-btn { display: none !important; }

        .wide-search-container { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; background-color: #f1f5f9; }
        .wide-search-container:focus-within { background-color: white; border-color: #2563eb; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1); }

        .loading-skeleton { background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2.5 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 md:w-9 md:h-9 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-md shadow-blue-200">
                    <i data-lucide="play" fill="white" class="w-3.5 h-3.5 md:w-4 md:h-4 ml-0.5"></i>
                </div>
                <span class="font-extrabold text-lg md:text-xl tracking-tighter text-slate-900">옥튜브</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="handleLogout()" class="admin-only items-center gap-1.5 bg-rose-50 text-rose-600 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-[10px] md:text-[11px] font-bold border border-rose-100 hover:bg-rose-100 transition-colors">
                    <span class="w-1.5 h-1.5 bg-rose-500 rounded-full animate-pulse"></span>
                    로그아웃
                </button>
                <button onclick="requestToken(true)" class="login-btn bg-slate-100 text-slate-600 px-4 py-2 md:px-5 md:py-2.5 rounded-full text-[10px] md:text-xs font-bold hover:bg-slate-200 transition-colors">관리자 로그인</button>
                <button onclick="openAdmin()" class="admin-only bg-blue-600 text-white px-4 py-2 md:px-5 md:py-2.5 rounded-full text-[10px] md:text-xs font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">영상 등록</button>
            </div>
        </div>
    </header>

    <section class="bg-white">
        <div class="max-w-7xl mx-auto px-4 py-4 md:py-6">
            <div class="max-w-4xl mx-auto space-y-4 md:space-y-6">
                <div class="relative group">
                    <div class="wide-search-container flex items-center rounded-2xl px-4 py-3 md:px-6 md:py-4">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-blue-600 transition-colors"></i>
                        <input type="text" id="video-search" oninput="handleSearch(this.value)" placeholder="찾고 있는 공략이나 영상을 입력하세요" class="bg-transparent border-none outline-none ml-2 md:ml-3 w-full text-sm md:text-lg font-semibold text-slate-800 placeholder-slate-400">
                    </div>
                </div>
                <div id="category-filters" class="flex flex-nowrap md:flex-wrap justify-start md:justify-center gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide">
                    <button onclick="filterVideos('전체')" class="filter-btn active whitespace-nowrap px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm font-bold flex-shrink-0">전체</button>
                    <button onclick="filterVideos('단기컷')" class="filter-btn whitespace-nowrap px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm font-bold flex-shrink-0">단기컷</button>
                    <button onclick="filterVideos('공략')" class="filter-btn whitespace-nowrap px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm font-bold flex-shrink-0">공략</button>
                    <button onclick="filterVideos('가이드')" class="filter-btn whitespace-nowrap px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm font-bold flex-shrink-0">가이드</button>
                    <button onclick="filterVideos('기타')" class="filter-btn whitespace-nowrap px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm font-bold flex-shrink-0">기타</button>
                </div>
            </div>
        </div>
    </section>

    <main class="max-w-7xl mx-auto px-4 pb-20 pt-2 md:pt-4">
        <div class="flex items-center justify-between mb-6 md:mb-8 border-b border-slate-100 pb-3 md:pb-4">
            <div class="flex items-center gap-2 font-extrabold text-base md:text-lg text-slate-800">
                <i data-lucide="layout-grid" class="w-4 h-4 md:w-5 md:h-5 text-blue-600"></i>
                콘텐츠 아카이브
            </div>
            <span id="video-count" class="text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-wider">총 0개</span>
        </div>
        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-7"></div>
    </main>

    <div id="admin-modal" class="fixed inset-0 z-[1100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[32px] md:rounded-[40px] p-6 md:p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 md:mb-8">
                <h2 id="modal-title" class="text-xl md:text-2xl font-extrabold tracking-tight">새 영상 업로드</h2>
                <button onclick="closeAdmin()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="upload-step-1" class="space-y-4">
                <div class="border-3 border-dashed border-slate-200 rounded-[24px] md:rounded-[32px] p-8 md:p-16 text-center hover:border-blue-500 hover:bg-blue-50/30 transition-all group">
                    <input type="file" id="video-input" accept="video/*" class="hidden" onchange="handleFileSelect(event)">
                    <label for="video-input" class="cursor-pointer block">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-5 group-hover:scale-110 transition-transform">
                            <i data-lucide="upload-cloud" class="w-8 h-8 md:w-10 md:h-10"></i>
                        </div>
                        <p class="text-slate-700 font-extrabold text-base md:text-lg">영상 파일을 선택하세요</p>
                    </label>
                </div>
            </div>
            <div id="upload-step-2" class="hidden space-y-6">
                <div class="text-center">
                    <p id="step-2-guide" class="text-blue-600 font-bold mb-4 md:mb-6 text-xs md:sm italic">썸네일을 선택하고 정보를 입력하세요</p>
                    <div id="thumbnail-container" class="grid grid-cols-5 gap-2 mb-6 md:mb-8"></div>
                    <div class="space-y-4 text-left">
                        <input id="input-title" type="text" placeholder="영상 제목" class="w-full px-5 py-3.5 md:px-6 md:py-4 bg-slate-50 border-none rounded-xl md:rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-base md:text-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="input-category" class="w-full px-5 py-3.5 md:px-6 md:py-4 bg-slate-50 border-none rounded-xl md:rounded-2xl outline-none font-bold cursor-pointer text-sm">
                                <option value="단기컷">단기컷</option>
                                <option value="공략">공략</option>
                                <option value="가이드">가이드</option>
                                <option value="기타">기타</option>
                            </select>
                            <input id="input-author" type="text" placeholder="작성자" class="w-full px-5 py-3.5 md:px-6 md:py-4 bg-slate-50 border-none rounded-xl md:rounded-2xl outline-none font-bold text-sm">
                        </div>
                    </div>
                    <button id="final-action-btn" onclick="handleFinalAction()" class="w-full py-4 md:py-5 bg-blue-600 text-white font-extrabold rounded-xl md:rounded-2xl mt-6 md:mt-8 shadow-xl shadow-blue-200 hover:bg-blue-700 transition-all text-base md:text-lg">
                        등록 완료
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[2000] hidden flex-col items-center justify-center text-white text-center p-6">
        <div class="w-12 h-12 md:w-14 md:h-14 border-4 border-blue-600/30 border-t-blue-600 rounded-full animate-spin mb-6"></div>
        <p id="loading-text" class="font-extrabold text-lg md:text-xl"></p>
        <p id="loading-sub" class="text-slate-300 text-xs md:sm mt-2"></p>
    </div>

    <div id="player-modal" class="fixed inset-0 z-[1000] hidden flex-col items-center justify-center p-4" onclick="closePlayer()">
        <div class="w-full max-w-5xl" onclick="event.stopPropagation()">
            <div id="video-frame" class="bg-black rounded-2xl md:rounded-[32px] overflow-hidden aspect-video shadow-2xl relative border border-white/10">
                <div id="iframe-loader" class="absolute inset-0 z-0 loading-skeleton flex flex-col items-center justify-center">
                    <div class="w-8 h-8 md:w-10 md:h-10 border-3 border-white/20 border-t-white/80 rounded-full animate-spin"></div>
                </div>
            </div>
            <div class="mt-6 md:mt-8 flex flex-wrap justify-center gap-2 md:gap-4">
                <button onclick="closePlayer()" class="text-white bg-white/10 px-6 py-2.5 md:px-8 md:py-3 rounded-full text-xs md:text-sm font-bold hover:bg-white/20 transition-colors backdrop-blur-md">닫기</button>
                <button onclick="openEditMode()" class="admin-only text-blue-400 bg-blue-400/10 px-6 py-2.5 md:px-8 md:py-3 rounded-full text-xs md:text-sm font-bold hover:bg-blue-400/20 transition-colors backdrop-blur-md">수정</button>
                <button onclick="deleteVideo()" class="admin-only text-rose-500 bg-rose-500/10 px-6 py-2.5 md:px-8 md:py-3 rounded-full text-xs md:text-sm font-bold hover:bg-rose-500/20 transition-colors backdrop-blur-md">삭제</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const CLIENT_ID = '131660349524-lfu2c56t4ent6167fu68essbleoquptp.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const targetCollection = collection(db, 'artifacts', 'octopath-85851', 'public', 'data', 'videos');

        let selectedFile, selectedThumb, tokenClient, accessToken;
        let currentEditingVideo = null; 
        let allVideos = [];
        let currentFilter = '전체';
        let searchQuery = '';
        let pendingProcess = false;

        window.onload = async () => {
            try {
                await signInAnonymously(auth);
                loadVideos();
                initGoogleAuth();
                const savedToken = sessionStorage.getItem('drive_token');
                if (savedToken) {
                    accessToken = savedToken;
                    document.body.classList.add('is-admin');
                }
            } catch (e) { console.error(e); }
        };

        function initGoogleAuth() {
            if (typeof google !== 'undefined') {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) {
                            pendingProcess = false;
                            return;
                        }
                        accessToken = resp.access_token;
                        sessionStorage.setItem('drive_token', accessToken);
                        document.body.classList.add('is-admin');
                        if (pendingProcess) {
                            pendingProcess = false;
                            startProcess();
                        }
                    },
                });
            }
        }

        window.handleLogout = () => {
            if(confirm("관리자 로그아웃 하시겠습니까?")) {
                accessToken = null;
                sessionStorage.removeItem('drive_token');
                document.body.classList.remove('is-admin');
                closePlayer();
                closeAdmin();
            }
        };

        function loadVideos() {
            onSnapshot(targetCollection, (snap) => {
                allVideos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                    .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderVideos();
            }, (error) => console.error(error));
        }

        window.handleSearch = (val) => { searchQuery = (val || '').toLowerCase().trim(); renderVideos(); };
        window.filterVideos = (cat) => {
            currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === cat));
            renderVideos();
        };

        function renderVideos() {
            const grid = document.getElementById('video-grid');
            if (!grid) return;
            const filtered = allVideos.filter(v => {
                const categoryMatch = (currentFilter === '전체' || v.category === currentFilter);
                const titleStr = (v.title || '').toLowerCase();
                const authorStr = (v.author || '').toLowerCase();
                return categoryMatch && (titleStr.includes(searchQuery) || authorStr.includes(searchQuery));
            });
            document.getElementById('video-count').innerText = `총 ${filtered.length}개`;
            grid.innerHTML = filtered.length === 0 ? `<div class="col-span-full py-20 text-center text-slate-300 font-bold text-sm">콘텐츠가 없습니다.</div>` :
                filtered.map(v => `
                    <div class="video-card" onclick="openPlayer('${v.fileId}', '${v.id}', ${JSON.stringify(v).replace(/"/g, '&quot;')})">
                        <div class="aspect-video bg-slate-100 relative">
                            <div class="author-badge"><i data-lucide="user" class="w-3.5 h-3.5" fill="white"></i><span>${v.author || '익명'}</span></div>
                            <img src="${v.thumbnail || ''}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-3 md:p-5"><span class="category-text">${v.category || '기타'}</span><h3 class="video-title line-clamp-2">${v.title || '제목 없음'}</h3></div>
                    </div>
                `).join('');
            lucide.createIcons();
        }

        window.handleFileSelect = async (e) => {
            selectedFile = e.target.files[0]; if (!selectedFile) return;
            showLoading("썸네일 추출 중...");
            const videoUrl = URL.createObjectURL(selectedFile);
            const video = document.createElement('video'); video.src = videoUrl; video.muted = true;
            video.onloadedmetadata = async () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const thumbs = [];
                for (let t of [0.1, 0.3, 0.5, 0.7, 0.9]) {
                    video.currentTime = t * video.duration;
                    await new Promise(r => { const sk = () => { video.removeEventListener('seeked', sk); setTimeout(r, 800); }; video.addEventListener('seeked', sk); });
                    canvas.width = 640; canvas.height = 360; ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    thumbs.push(canvas.toDataURL('image/jpeg', 0.8));
                }
                document.getElementById('upload-step-1').classList.add('hidden');
                document.getElementById('upload-step-2').classList.remove('hidden');
                document.getElementById('thumbnail-container').innerHTML = thumbs.map((src, i) => `
                    <div class="thumb-option ${i===2?'selected':''}" onclick="selectThumb(this, '${src}')">
                        <img src="${src}" class="w-full aspect-video object-cover rounded-lg">
                    </div>`).join('');
                selectedThumb = thumbs[2]; hideLoading(); URL.revokeObjectURL(videoUrl);
            };
        };

        window.selectThumb = (el, src) => { document.querySelectorAll('.thumb-option').forEach(t => t.classList.remove('selected')); el.classList.add('selected'); selectedThumb = src; };

        window.handleFinalAction = () => {
            const title = document.getElementById('input-title').value.trim();
            if (!selectedThumb || !title) return alert("정보를 모두 입력해주세요.");
            
            if (currentEditingVideo) {
                updateExistingVideo(); 
            } else {
                if (!accessToken) {
                    pendingProcess = true;
                    tokenClient.requestAccessToken({ prompt: '' });
                } else {
                    startProcess();
                }
            }
        };

        async function updateExistingVideo() {
            showLoading("정보 수정 중...");
            try {
                await updateDoc(doc(db, 'artifacts', 'octopath-85851', 'public', 'data', 'videos', currentEditingVideo.id), {
                    title: document.getElementById('input-title').value,
                    category: document.getElementById('input-category').value,
                    author: document.getElementById('input-author').value || '익명'
                });
                location.reload();
            } catch (e) { alert("수정 실패"); hideLoading(); }
        }

        window.requestToken = (interactive = false) => {
            tokenClient.requestAccessToken({ prompt: interactive ? 'select_account' : '' });
        };

        async function startProcess() {
            showLoading("폴더 조회 중...");
            try {
                const folderId = await findOrCreateFolder('octo_media');
                showLoading("파일 업로드 중...", "영상을 전송하고 있습니다.");
                const fileId = await uploadFileToDrive(folderId);
                
                showLoading("데이터베이스 등록 중...");
                await addDoc(targetCollection, {
                    fileId, thumbnail: selectedThumb,
                    title: document.getElementById('input-title').value,
                    category: document.getElementById('input-category').value,
                    author: document.getElementById('input-author').value || '익명',
                    timestamp: serverTimestamp()
                });
                
                hideLoading();
                location.reload();
            } catch (err) { 
                if (err.status === 401) {
                    accessToken = null;
                    sessionStorage.removeItem('drive_token');
                    pendingProcess = true;
                    tokenClient.requestAccessToken({ prompt: '' });
                } else {
                    alert("오류 발생: " + err.message);
                    hideLoading(); 
                }
            }
        }

        async function findOrCreateFolder(name) {
            const q = encodeURIComponent(`name = '${name}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`);
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}`, { 
                headers: { 'Authorization': `Bearer ${accessToken}` } 
            });
            if (!res.ok) { const err = new Error("Folder Search Failed"); err.status = res.status; throw err; }
            const data = await res.json();
            if (data.files?.length > 0) return data.files[0].id;
            
            const cr = await fetch('https://www.googleapis.com/drive/v3/files', {
                method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, mimeType: 'application/vnd.google-apps.folder' })
            });
            const folderData = await cr.json();
            return folderData.id;
        }

        async function uploadFileToDrive(folderId) {
            const metadata = { name: selectedFile.name, parents: [folderId], mimeType: selectedFile.type || 'video/mp4' };
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                method: 'POST', headers: { 
                    'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json; charset=UTF-8',
                    'X-Upload-Content-Type': selectedFile.type || 'video/mp4', 'X-Upload-Content-Length': selectedFile.size
                },
                body: JSON.stringify(metadata)
            });

            if (!response.ok) { const e = await response.json(); throw new Error(e.error.message); }
            const uploadUrl = response.headers.get('Location');
            const uploadRes = await fetch(uploadUrl, { method: 'PUT', body: selectedFile });
            if (!uploadRes.ok) throw new Error("전송 실패");
            const finalData = await uploadRes.json();
            return finalData.id;
        }

        window.openPlayer = (fileId, docId, videoData) => {
            currentEditingVideo = { id: docId, ...videoData };
            const frame = document.getElementById('video-frame');
            document.getElementById('iframe-loader').style.display = 'flex';
            const ifr = document.createElement('iframe');
            ifr.src = `https://drive.google.com/file/d/${fileId}/preview`;
            ifr.className = "w-full h-full relative z-10";
            ifr.onload = () => document.getElementById('iframe-loader').style.display = 'none';
            frame.appendChild(ifr);
            document.getElementById('player-modal').classList.replace('hidden', 'flex');
        };

        window.closePlayer = () => {
            document.getElementById('video-frame').querySelectorAll('iframe').forEach(f => f.remove());
            document.getElementById('player-modal').classList.replace('flex', 'hidden');
        };

        window.openEditMode = () => {
            document.getElementById('modal-title').innerText = "정보 수정";
            document.getElementById('upload-step-1').classList.add('hidden');
            document.getElementById('upload-step-2').classList.remove('hidden');
            document.getElementById('input-title').value = currentEditingVideo.title || '';
            document.getElementById('input-category').value = currentEditingVideo.category || '기타';
            document.getElementById('input-author').value = currentEditingVideo.author || '';
            selectedThumb = currentEditingVideo.thumbnail;
            document.getElementById('thumbnail-container').innerHTML = `<div class="thumb-option selected col-span-2"><img src="${selectedThumb}" class="w-full rounded-lg"></div>`;
            document.getElementById('admin-modal').classList.replace('hidden', 'flex');
        };

        window.deleteVideo = async () => {
            if (!confirm("정말로 삭제하시겠습니까?")) return;
            showLoading("삭제 중...");
            try {
                if (accessToken) {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${currentEditingVideo.fileId}`, { 
                        method: 'DELETE', 
                        headers: { 'Authorization': `Bearer ${accessToken}` } 
                    });
                }
                await deleteDoc(doc(db, 'artifacts', 'octopath-85851', 'public', 'data', 'videos', currentEditingVideo.id));
                location.reload();
            } catch (e) { alert("삭제 실패"); hideLoading(); }
        };

        window.openAdmin = () => {
            currentEditingVideo = null; document.getElementById('modal-title').innerText = "새 영상 업로드";
            document.getElementById('upload-step-1').classList.remove('hidden');
            document.getElementById('upload-step-2').classList.add('hidden');
            document.getElementById('admin-modal').classList.replace('hidden', 'flex');
        };
        window.closeAdmin = () => document.getElementById('admin-modal').classList.replace('flex', 'hidden');
        
        function showLoading(t, sub = "") { 
            document.getElementById('loading-text').innerText = t; document.getElementById('loading-sub').innerText = sub; 
            document.getElementById('loading-overlay').classList.replace('hidden', 'flex'); 
        }
        function hideLoading() { document.getElementById('loading-overlay').classList.replace('flex', 'hidden'); }
    </script>
</body>
</html>
