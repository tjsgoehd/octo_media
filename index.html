<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>옥튜브 - 구글 드라이브 스마트 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; letter-spacing: -0.025em; }
        .video-card { background: white; border-radius: 12px; overflow: hidden; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04); cursor: pointer; }
        .video-card:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1); }
        .thumb-option { border: 4px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s; position: relative; }
        .thumb-option.selected { border-color: #2563eb; transform: scale(1.05); z-index: 10; }
        #player-modal, #admin-modal, #loading-overlay { backdrop-filter: blur(16px); background-color: rgba(0, 0, 0, 0.85); }
        .progress-bar { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                    <i data-lucide="play" fill="currentColor" class="w-4 h-4 ml-0.5"></i>
                </div>
                <span class="font-extrabold text-lg tracking-tighter">옥튜브</span>
            </div>
            <button onclick="openAdmin()" class="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-800 transition-colors">영상 등록</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="auth-warning" class="hidden mb-6 bg-red-50 border border-red-200 p-5 rounded-2xl flex items-start gap-4">
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center shrink-0">
                <i data-lucide="shield-alert" class="text-red-600 w-6 h-6"></i>
            </div>
            <div>
                <p class="text-red-900 font-extrabold text-base mb-1">Firebase 권한 설정 확인</p>
                <p class="text-red-700 text-sm leading-relaxed font-medium">
                    데이터를 불러오거나 저장하는 데 문제가 발생했습니다. Firestore 규칙과 코드의 경로가 일치하는지 확인해 주세요.
                </p>
            </div>
        </div>

        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8">
            <div id="loading-placeholder" class="col-span-full py-32 text-center text-slate-400 font-medium">
                <p>데이터를 불러오는 중입니다...</p>
            </div>
        </div>
    </main>

    <div id="admin-modal" class="fixed inset-0 z-[1100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">새 영상 업로드</h2>
                <button onclick="closeAdmin()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            
            <div id="upload-step-1" class="space-y-6">
                <div class="bg-blue-50 border border-blue-100 p-5 rounded-2xl">
                    <p class="text-blue-800 font-bold text-sm mb-1">안내사항</p>
                    <p class="text-blue-700 text-xs leading-relaxed">
                        구글 드라이브에 영상이 업로드되며, 자동으로 전체 공개 권한이 부여됩니다.
                    </p>
                </div>
                <div class="border-2 border-dashed border-slate-200 rounded-3xl p-10 text-center hover:border-blue-500 transition-colors">
                    <input type="file" id="video-input" accept="video/*" class="hidden" onchange="handleFileSelect(event)">
                    <label for="video-input" class="cursor-pointer block">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                        </div>
                        <p class="text-slate-600 font-bold">영상 파일을 선택하세요</p>
                    </label>
                </div>
            </div>

            <div id="upload-step-2" class="hidden space-y-6">
                <div class="text-center">
                    <p class="text-sm font-bold mb-4">썸네일 선택 및 정보 입력</p>
                    <div id="thumbnail-container" class="grid grid-cols-5 gap-2 mb-6"></div>
                    <div class="space-y-3 text-left">
                        <label class="text-xs font-bold text-slate-400 ml-1">영상 제목</label>
                        <input id="input-title" type="text" placeholder="제목을 입력하세요" class="w-full px-4 py-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all mb-2">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-slate-400 ml-1">카테고리</label>
                                <select id="input-category" class="w-full px-4 py-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                    <option value="단기컷">단기컷</option>
                                    <option value="공략">공략</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 ml-1">작성자</label>
                                <input id="input-author" type="text" placeholder="이름" class="w-full px-4 py-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                        </div>
                    </div>
                    <button id="auth-btn" onclick="requestToken()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl mt-6 shadow-lg hover:bg-blue-700 transition-all active:scale-95">
                        구글 로그인 및 업로드 시작
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 z-[2000] hidden flex-col items-center justify-center text-white">
        <div id="spinner" class="w-12 h-12 border-4 border-blue-600/30 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="font-bold mb-4 text-center px-6"></p>
        <div id="progress-container" class="w-64 h-2 bg-white/20 rounded-full overflow-hidden hidden">
            <div id="progress-bar" class="progress-bar h-full bg-blue-500 w-0"></div>
        </div>
    </div>

    <div id="player-modal" class="fixed inset-0 z-[1000] hidden flex-col items-center justify-center p-4" onclick="closePlayer()">
        <div class="w-full max-w-4xl" onclick="event.stopPropagation()">
            <div id="video-frame" class="bg-black rounded-3xl overflow-hidden aspect-video shadow-2xl relative"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const CLIENT_ID = '131660349524-lfu2c56t4ent6167fu68essbleoquptp.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836",
            measurementId: "G-T66TC51C7W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 중요: 규칙에 명시된 경로와 정확히 일치해야 함
        const COLLECTION_PATH = ['artifacts', 'octopath-85851', 'public', 'data', 'videos'];

        let selectedFile, selectedThumb, tokenClient, currentUser = null;
        let unsubscribeVideos = null;

        function loadVideos() {
            if (unsubscribeVideos) return;
            const grid = document.getElementById('video-grid');
            
            // 규칙과 일치하는 전체 경로 사용
            const colRef = collection(db, ...COLLECTION_PATH);
            
            unsubscribeVideos = onSnapshot(colRef, (snap) => {
                const videos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (videos.length === 0) {
                    grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400">등록된 영상이 없습니다.</div>`;
                    return;
                }
                
                const sortedVideos = videos.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                grid.innerHTML = sortedVideos.map(v => `
                    <div class="video-card" onclick="openPlayer('${v.url}')">
                        <img src="${v.thumbnail}" class="w-full aspect-video object-cover" onerror="this.src='https://via.placeholder.com/640x360?text=Thumbnail+Error'">
                        <div class="p-4">
                            <p class="text-[10px] font-bold text-blue-600 uppercase mb-1">${v.category || '기타'}</p>
                            <h3 class="font-bold text-sm truncate text-slate-800">${v.title}</h3>
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-[10px] text-slate-400">${v.author || '익명'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            }, (error) => {
                console.error("Firestore Loading Error:", error);
                document.getElementById('auth-warning').classList.remove('hidden');
            });
        }

        function initTokenClient() {
            if (typeof google === 'undefined' || !google.accounts) {
                setTimeout(initTokenClient, 500);
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) { hideLoading(); alert("구글 인증 오류: " + resp.error); return; }
                    if (resp.access_token) startResumableUpload(resp.access_token);
                },
            });
        }

        window.onload = async () => {
            try {
                const userCredential = await signInAnonymously(auth);
                currentUser = userCredential.user;
                loadVideos();
            } catch (error) {
                console.error("Auth Error:", error);
                loadVideos();
            }
            initTokenClient();
        };

        window.requestToken = () => {
            const title = document.getElementById('input-title').value;
            if (!selectedThumb || !title) return alert("제목과 썸네일을 확인해 주세요.");
            showLoading("구글 계정 인증 대기 중...");
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        window.handleFileSelect = async (e) => {
            selectedFile = e.target.files[0];
            if (!selectedFile) return;

            showLoading("영상을 분석하여 썸네일을 생성 중...");
            const videoUrl = URL.createObjectURL(selectedFile);
            const video = document.createElement('video');
            video.src = videoUrl;
            video.muted = true;
            
            video.onloadedmetadata = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const thumbs = [];
                const points = [0.1, 0.3, 0.5, 0.7, 0.9];
                for (let t of points) {
                    video.currentTime = t * video.duration;
                    await new Promise(r => video.onseeked = r);
                    canvas.width = 640; canvas.height = 360;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    thumbs.push(canvas.toDataURL('image/jpeg', 0.7));
                }
                document.getElementById('upload-step-1').classList.add('hidden');
                document.getElementById('upload-step-2').classList.remove('hidden');
                document.getElementById('thumbnail-container').innerHTML = thumbs.map(src => `
                    <div class="thumb-option" onclick="selectThumb(this, '${src}')">
                        <img src="${src}" class="w-full aspect-video object-cover rounded-lg">
                    </div>
                `).join('');
                hideLoading();
                URL.revokeObjectURL(videoUrl);
            };
        };

        window.selectThumb = (el, src) => {
            document.querySelectorAll('.thumb-option').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
            selectedThumb = src;
        };

        async function startResumableUpload(token) {
            showLoading("구글 드라이브에 영상 저장 중...", true);
            try {
                const metadata = { name: selectedFile.name, mimeType: selectedFile.type };
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json; charset=UTF-8',
                        'X-Upload-Content-Type': selectedFile.type
                    },
                    body: JSON.stringify(metadata)
                });
                const uploadUrl = response.headers.get('Location');
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', uploadUrl, true);
                xhr.upload.onprogress = (e) => {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('progress-bar').style.width = percent + '%';
                    document.getElementById('loading-text').innerText = `드라이브 저장 중... (${percent}%)`;
                };
                xhr.onload = async () => { if (xhr.status < 300) finalizeProcess(JSON.parse(xhr.response).id, token); };
                xhr.send(selectedFile);
            } catch (err) { alert("업로드 실패"); hideLoading(); }
        }

        async function finalizeProcess(fileId, token) {
            showLoading("아카이브 등록 마무리 중...");
            try {
                await fetch(`https://www.googleapis.com/api/drive/v3/files/${fileId}/permissions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'reader', type: 'anyone' })
                });

                // 규칙에 허용된 전체 경로에 문서 추가
                await addDoc(collection(db, ...COLLECTION_PATH), {
                    url: `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${firebaseConfig.apiKey}`,
                    thumbnail: selectedThumb,
                    title: document.getElementById('input-title').value,
                    category: document.getElementById('input-category').value,
                    author: document.getElementById('input-author').value || '익명',
                    timestamp: serverTimestamp()
                });
                
                alert("성공적으로 등록되었습니다!");
                location.reload();
            } catch (err) { 
                console.error("Save Error:", err);
                alert("Firestore 저장 실패! 코드의 저장 경로와 파이어베이스 규칙을 다시 확인하세요."); 
                hideLoading(); 
            }
        }

        window.openPlayer = (url) => {
            document.getElementById('video-frame').innerHTML = `<video src="${url}" controls autoplay class="w-full h-full bg-black"></video>`;
            document.getElementById('player-modal').classList.replace('hidden', 'flex');
        };
        window.closePlayer = () => {
            document.getElementById('video-frame').innerHTML = '';
            document.getElementById('player-modal').classList.replace('flex', 'hidden');
        };
        window.openAdmin = () => document.getElementById('admin-modal').classList.replace('hidden', 'flex');
        window.closeAdmin = () => document.getElementById('admin-modal').classList.replace('flex', 'hidden');
        function showLoading(t, showProgress = false) { 
            document.getElementById('loading-text').innerText = t; 
            document.getElementById('loading-overlay').classList.replace('hidden', 'flex');
            document.getElementById('progress-container').classList.toggle('hidden', !showProgress);
            document.getElementById('spinner').classList.toggle('hidden', showProgress);
        }
        function hideLoading() { document.getElementById('loading-overlay').classList.replace('flex', 'hidden'); }
    </script>
</body>
</html>
