<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OKTUBE | 프리미엄 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #020617; 
            color: #f8fafc;
            letter-spacing: -0.025em; 
        }

        .glass-header { 
            backdrop-filter: blur(20px); 
            background: rgba(2, 6, 23, 0.8); 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }

        .video-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            background: #0f172a;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .video-card:hover {
            transform: translateY(-4px);
            border-color: #3b82f6;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .cat-btn {
            background: #1e293b;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .cat-btn.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .shimmer {
            background: linear-gradient(90deg, #0f172a 25%, #1e293b 50%, #0f172a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* 플레이어 모달 애니메이션 */
        #player-container.show {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <header class="sticky top-0 z-[60] glass-header px-4 md:px-12 h-16 md:h-20 flex items-center justify-between">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-lg md:rounded-xl flex items-center justify-center text-white shadow-lg">
                <i data-lucide="play" fill="currentColor" class="w-4 h-4 md:w-5 md:h-5 ml-0.5"></i>
            </div>
            <span class="font-bold text-lg md:text-xl tracking-tight uppercase">Oktube</span>
        </div>
        <button onclick="openAdminLogin()" class="bg-white/5 hover:bg-white/10 text-white/70 px-4 py-2 rounded-full text-xs font-semibold transition-all border border-white/10">
            ADMIN
        </button>
    </header>

    <main class="max-w-[1400px] mx-auto px-4 md:px-12 py-6 md:py-10">
        <nav class="flex gap-2 overflow-x-auto pb-6 mb-2 no-scrollbar">
            <button onclick="filterCat('전체')" class="cat-btn active whitespace-nowrap px-6 py-2.5 rounded-full text-xs md:text-sm font-bold shadow-sm">전체</button>
            <button onclick="filterCat('단기컷')" class="cat-btn whitespace-nowrap px-6 py-2.5 rounded-full text-xs md:text-sm font-bold shadow-sm">단기컷</button>
            <button onclick="filterCat('공략')" class="cat-btn whitespace-nowrap px-6 py-2.5 rounded-full text-xs md:text-sm font-bold shadow-sm">공략</button>
            <button onclick="filterCat('기타')" class="cat-btn whitespace-nowrap px-6 py-2.5 rounded-full text-xs md:text-sm font-bold shadow-sm">기타</button>
        </nav>

        <div id="video-grid" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-x-6 md:gap-y-10">
            <div class="shimmer aspect-video rounded-3xl"></div>
            <div class="shimmer aspect-video rounded-3xl"></div>
            <div class="shimmer aspect-video rounded-3xl"></div>
            <div class="shimmer aspect-video rounded-3xl"></div>
        </div>
    </main>

    <!-- Player Modal -->
    <div id="player-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/95 backdrop-blur-xl p-0 md:p-6" onclick="if(event.target === this) closePlayer()">
        <div id="player-container" class="w-full max-w-5xl bg-black md:rounded-[2rem] overflow-hidden shadow-2xl relative scale-95 opacity-0 transition-all duration-300 border border-white/10">
            
            <!-- Header Overlay -->
            <div class="absolute top-0 left-0 right-0 p-4 md:p-6 flex justify-between items-center z-20 bg-gradient-to-b from-black/90 to-transparent">
                <div class="pr-10">
                    <h2 id="player-title" class="text-white font-bold text-sm md:text-lg line-clamp-1">영상 제목</h2>
                    <p id="player-info" class="text-white/50 text-[10px] md:text-xs">분류 · 작성자</p>
                </div>
                <button onclick="closePlayer()" class="w-8 h-8 md:w-10 md:h-10 bg-white/10 hover:bg-white/20 text-white rounded-full flex items-center justify-center transition-all">
                    <i data-lucide="x" class="w-4 h-4 md:w-5 md:h-5"></i>
                </button>
            </div>
            
            <!-- Video Area -->
            <div class="w-full aspect-video bg-black flex items-center justify-center relative">
                <div id="player-loader" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-950">
                    <div class="w-10 h-10 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                    <p class="text-slate-400 text-xs">구글 서버에서 불러오는 중...</p>
                </div>

                <iframe 
                    id="player-iframe" 
                    class="w-full h-full relative z-20" 
                    src="" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture" 
                    allowfullscreen
                    onload="document.getElementById('player-loader').style.display='none'">
                </iframe>
            </div>

            <!-- Footer Fail-safe -->
            <div class="p-4 bg-slate-900 border-t border-white/5 flex flex-col md:flex-row gap-3 items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] md:text-xs text-slate-400 text-center md:text-left">
                    <i data-lucide="alert-circle" class="w-3.5 h-3.5 text-blue-500"></i>
                    <span>화면이 나오지 않으면 브라우저 설정에서 <b>[타사 쿠키 허용]</b>을 활성화하거나 아래 버튼을 클릭하세요.</span>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <a id="external-link" href="#" target="_blank" class="flex-1 md:flex-none flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg">
                        <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                        외부 플레이어로 재생
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.allVideos = [];
        let currentCategory = '전체';

        window.onload = async () => {
            await signInAnonymously(auth);
            fetchVideos();
            lucide.createIcons();
        };

        function fetchVideos() {
            const vRef = collection(db, 'artifacts', 'oktube-drive-v1', 'public', 'data', 'videos');
            onSnapshot(vRef, (snap) => {
                window.allVideos = snap.docs.map(doc => ({id: doc.id, ...doc.data()}))
                                .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            });
        }

        function render() {
            const grid = document.getElementById('video-grid');
            const filtered = currentCategory === '전체' ? window.allVideos : window.allVideos.filter(v => v.category === currentCategory);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-40 text-center text-slate-500 font-medium">등록된 영상이 없습니다.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(v => `
                <div class="video-card cursor-pointer group" onclick='window.openPlayer(${JSON.stringify(v).replace(/'/g, "&apos;")})'>
                    <div class="aspect-video bg-slate-800 relative overflow-hidden">
                        <img src="${v.thumbnail || 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=800&auto=format&fit=crop'}" 
                             class="w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity duration-500">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-12 h-12 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="play" fill="white" class="w-5 h-5 text-white ml-0.5"></i>
                            </div>
                        </div>
                        <div class="absolute bottom-2 left-2 bg-black/60 backdrop-blur-sm text-[10px] font-bold px-2 py-1 rounded text-white/80 border border-white/5">
                            ${v.author}
                        </div>
                    </div>
                    <div class="p-4">
                        <p class="text-blue-500 text-[10px] font-black mb-1 uppercase tracking-widest">${v.category}</p>
                        <h3 class="font-bold text-sm md:text-base text-slate-200 line-clamp-1 group-hover:text-blue-400 transition-colors">${v.title}</h3>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.openPlayer = (video) => {
            const modal = document.getElementById('player-modal');
            const container = document.getElementById('player-container');
            const iframe = document.getElementById('player-iframe');
            const extLink = document.getElementById('external-link');

            document.getElementById('player-title').innerText = video.title;
            document.getElementById('player-info').innerText = `${video.category} · ${video.author}`;

            const fileIdMatch = video.url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            const fileId = fileIdMatch ? fileIdMatch[1] : "";
            
            // 핵심 수정: 연결 거부를 피하기 위해 preview URL을 사용하되, 
            // 샌드박스 정책을 우회하기 위해 iframe 속성을 확인해야 합니다.
            iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
            extLink.href = `https://drive.google.com/file/d/${fileId}/view`;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            setTimeout(() => {
                container.classList.add('show');
            }, 50);

            document.body.style.overflow = 'hidden';
        };

        window.closePlayer = () => {
            const modal = document.getElementById('player-modal');
            const container = document.getElementById('player-container');
            const iframe = document.getElementById('player-iframe');
            
            container.classList.remove('show');
            setTimeout(() => {
                iframe.src = "";
                modal.classList.replace('flex', 'hidden');
                document.body.style.overflow = '';
            }, 300);
        };

        window.filterCat = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.innerText === cat));
            render();
        };

        window.openAdminLogin = () => {
            const pw = prompt("관리자 키를 입력하세요.");
            if(pw === "8585") alert("관리자 모드 준비 중");
        };
    </script>
</body>
</html>
