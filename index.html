<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì˜¥íŠœë¸Œ - êµ¬ê¸€ ë“œë¼ì´ë¸Œ ìŠ¤ë§ˆíŠ¸ ì•„ì¹´ì´ë¸Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Identity Services & API Loader -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; letter-spacing: -0.025em; }
        .video-card { background: white; border-radius: 12px; overflow: hidden; transition: all 0.25s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04); cursor: pointer; }
        .video-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .thumb-option { border: 4px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .thumb-option.selected { border-color: #2563eb; transform: scale(1.05); }
        #player-modal, #admin-modal, #loading-overlay { backdrop-filter: blur(20px); background-color: rgba(0, 0, 0, 0.9); }
    </style>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                    <i data-lucide="play" fill="currentColor" class="w-4 h-4 ml-0.5"></i>
                </div>
                <span class="font-extrabold text-lg tracking-tighter">ì˜¥íŠœë¸Œ</span>
            </div>
            <button onclick="openAdmin()" class="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-800 transition-colors">ì˜ìƒ ë“±ë¡</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-2xl font-extrabold tracking-tight mb-1">ğŸ”¥ í”„ë¦¬ë¯¸ì—„ ì•„ì¹´ì´ë¸Œ</h1>
            <p class="text-slate-500 text-sm font-medium">êµ¬ê¸€ ë“œë¼ì´ë¸Œ ê¸°ë°˜ ê³ í™”ì§ˆ ìŠ¤íŠ¸ë¦¬ë°</p>
        </div>

        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8">
            <div class="col-span-full py-32 text-center text-slate-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </main>

    <!-- ê´€ë¦¬ì ë“±ë¡ ëª¨ë‹¬ -->
    <div id="admin-modal" class="fixed inset-0 z-[1100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ìƒˆ ì˜ìƒ ì—…ë¡œë“œ</h2>
                <button onclick="closeAdmin()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            
            <div id="upload-step-1" class="space-y-6">
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl text-blue-800 text-xs leading-relaxed">
                    <p class="font-bold mb-1">ğŸ’¡ ê¶Œí•œ ì„¤ì • ì™„ë£Œ í™•ì¸</p>
                    ìŠ¤í¬ë¦°ìƒ·ì˜ 'ë¯¼ê°í•˜ì§€ ì•Šì€ ë²”ìœ„' ì„¤ì •ì€ ì˜¬ë°”ë¥´ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì•„ë˜ ë²„íŠ¼ì„ í†µí•´ ì˜ìƒì„ ì„ íƒí•˜ë©´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì§„í–‰ë©ë‹ˆë‹¤.
                </div>
                <div class="border-2 border-dashed border-slate-200 rounded-3xl p-10 text-center hover:border-blue-500 transition-colors group relative">
                    <input type="file" id="video-input" accept="video/*" class="hidden" onchange="handleFileSelect(event)">
                    <label for="video-input" class="cursor-pointer block">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                        </div>
                        <p class="text-slate-600 font-bold">ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                    </label>
                </div>
            </div>

            <div id="upload-step-2" class="hidden space-y-6">
                <div class="text-center">
                    <p class="text-sm font-bold text-slate-800 mb-4">ëŒ€í‘œ ì¸ë„¤ì¼ ì„ íƒ</p>
                    <div id="thumbnail-container" class="grid grid-cols-5 gap-2 mb-8"></div>
                    <div class="space-y-4 text-left">
                        <input id="input-title" type="text" placeholder="ì˜ìƒ ì œëª©" class="w-full px-4 py-4 bg-slate-100 border-none rounded-2xl outline-none">
                        <div class="grid grid-cols-2 gap-3">
                            <select id="input-category" class="w-full px-4 py-4 bg-slate-100 border-none rounded-2xl outline-none">
                                <option value="ë‹¨ê¸°ì»·">ë‹¨ê¸°ì»·</option>
                                <option value="ê³µëµ">ê³µëµ</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                            <input id="input-author" type="text" placeholder="ì‘ì„±ì" class="w-full px-4 py-4 bg-slate-100 border-none rounded-2xl outline-none">
                        </div>
                    </div>
                    <button id="btn-final-submit" onclick="startFullProcess()" class="w-full py-5 bg-blue-600 text-white font-bold rounded-2xl mt-8 shadow-xl">
                        êµ¬ê¸€ ë¡œê·¸ì¸ ë° ì—…ë¡œë“œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="fixed inset-0 z-[2000] hidden flex-col items-center justify-center text-white">
        <div class="w-16 h-16 border-4 border-blue-600/30 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="font-bold text-lg text-center px-4"></p>
    </div>

    <!-- í”Œë ˆì´ì–´ ëª¨ë‹¬ -->
    <div id="player-modal" class="fixed inset-0 z-[1000] hidden flex-col items-center justify-center p-4">
        <div class="w-full max-w-5xl flex flex-col gap-4">
            <div class="flex items-center justify-between text-white px-2">
                <h2 id="p-title" class="text-lg font-bold"></h2>
                <button onclick="closePlayer()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i data-lucide="x"></i></button>
            </div>
            <div class="bg-black rounded-3xl overflow-hidden aspect-video relative border border-white/10 shadow-2xl">
                <div id="video-frame" class="w-full h-full"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // --- Config ---
        const CLIENT_ID = '131660349524-lfu2c56t4ent6167fu68essbleoquptp.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDGd9HdGJgdDqy-LB81rPtYzW4INOwccLU';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';

        const firebaseConfig = { 
            apiKey: API_KEY, 
            authDomain: "octopath-85851.firebaseapp.com", 
            projectId: "octopath-85851", 
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836" 
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'octopath-85851';

        let videoData = [];
        let selectedFile = null;
        let selectedThumbBase64 = null;
        let tokenClient;
        let accessToken = null;

        // --- Firebase Init ---
        onAuthStateChanged(auth, (user) => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), (snap) => {
                videoData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        });
        signInAnonymously(auth).catch(() => {});

        // --- Google API Loader ---
        window.onload = () => {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                });
                initTokenClient();
            });
        };

        function initTokenClient() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        proceedToUpload();
                    } else {
                        alert("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ ì—¬ë¶€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                        hideLoading();
                    }
                },
            });
        }

        // --- Core Logic ---
        window.handleFileSelect = async (e) => {
            selectedFile = e.target.files[0];
            if (!selectedFile) return;
            showLoading("ì˜ìƒì„ ë¶„ì„í•˜ì—¬ ì¸ë„¤ì¼ì„ ë§Œë“œëŠ” ì¤‘ì…ë‹ˆë‹¤...");
            const videoUrl = URL.createObjectURL(selectedFile);
            const thumbs = await extractThumbnails(videoUrl);
            document.getElementById('upload-step-1').classList.add('hidden');
            document.getElementById('upload-step-2').classList.remove('hidden');
            const thumbCont = document.getElementById('thumbnail-container');
            thumbCont.innerHTML = thumbs.map((src) => `
                <div class="thumb-option" onclick="selectThumb(this, '${src}')">
                    <img src="${src}" class="w-full aspect-video object-cover">
                </div>
            `).join('');
            hideLoading();
        };

        async function extractThumbnails(url) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.src = url;
                video.muted = true;
                video.onloadedmetadata = async () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const times = [0.1, 0.3, 0.5, 0.7, 0.9].map(p => p * video.duration);
                    const results = [];
                    for (let t of times) {
                        video.currentTime = t;
                        await new Promise(r => video.onseeked = r);
                        canvas.width = 640; canvas.height = 360;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        results.push(canvas.toDataURL('image/jpeg', 0.6));
                    }
                    resolve(results);
                };
            });
        }

        window.selectThumb = (el, src) => {
            document.querySelectorAll('.thumb-option').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
            selectedThumbBase64 = src;
        };

        window.startFullProcess = () => {
            if (!selectedThumbBase64 || !document.getElementById('input-title').value) {
                alert("ì œëª©ê³¼ ì¸ë„¤ì¼ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”."); return;
            }
            showLoading("êµ¬ê¸€ ì¸ì¦ íŒì—…ì„ í™•ì¸í•´ ì£¼ì„¸ìš”...");
            // ì¸ì¦ í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        async function proceedToUpload() {
            showLoading("ë“œë¼ì´ë¸Œì— ì˜ìƒì„ ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...");
            try {
                const metadata = { name: selectedFile.name, mimeType: selectedFile.type };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', selectedFile);

                const uploadResp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
                
                if (!uploadResp.ok) throw new Error("Drive Upload Failed");
                const fileInfo = await uploadResp.json();
                const fileId = fileInfo.id;

                updateLoadingText("íŒŒì¼ ê¶Œí•œì„ ê³µê°œë¡œ ë³€ê²½ ì¤‘ì…ë‹ˆë‹¤...");
                await fetch(`https://www.googleapis.com/api/drive/v3/files/${fileId}/permissions`, {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' }),
                    body: JSON.stringify({ role: 'reader', type: 'anyone' })
                });

                updateLoadingText("ë°ì´í„°ë² ì´ìŠ¤ì— ë“±ë¡ ì¤‘...");
                const directUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${API_KEY}`;
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), {
                    url: directUrl,
                    thumbnail: selectedThumbBase64,
                    title: document.getElementById('input-title').value,
                    category: document.getElementById('input-category').value,
                    author: document.getElementById('input-author').value || 'ê´€ë¦¬ì',
                    timestamp: serverTimestamp()
                });

                alert("ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload();
            } catch (err) {
                console.error(err);
                alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. êµ¬ê¸€ ì½˜ì†”ì˜ 'ìŠ¹ì¸ëœ ì›ë³¸'ì— í˜„ì¬ ë„ë©”ì¸ì´ ë“±ë¡ë˜ì—ˆëŠ”ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”.");
                hideLoading();
            }
        }

        function render() {
            const grid = document.getElementById('video-grid');
            if(videoData.length === 0) { 
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; 
                return; 
            }
            grid.innerHTML = videoData.map(v => `
                <div class="video-card group" onclick="openPlayer('${v.url}', '${v.title}')">
                    <div class="relative aspect-video">
                        <img src="${v.thumbnail}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-all">
                            <i data-lucide="play-circle" class="w-12 h-12 text-white fill-white/20"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-blue-600 mb-1 uppercase">${v.category}</p>
                        <h3 class="font-bold text-slate-800 text-sm truncate">${v.title}</h3>
                        <p class="text-[10px] text-slate-400 mt-2">${v.author}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.openPlayer = (url, title) => {
            document.getElementById('p-title').innerText = title;
            document.getElementById('video-frame').innerHTML = `<video src="${url}" controls autoplay class="w-full h-full bg-black"></video>`;
            document.getElementById('player-modal').classList.replace('hidden', 'flex');
        };

        window.closePlayer = () => {
            document.getElementById('video-frame').innerHTML = '';
            document.getElementById('player-modal').classList.replace('flex', 'hidden');
        };

        window.openAdmin = () => document.getElementById('admin-modal').classList.replace('hidden', 'flex');
        window.closeAdmin = () => document.getElementById('admin-modal').classList.replace('flex', 'hidden');
        function showLoading(txt) { document.getElementById('loading-text').innerText = txt; document.getElementById('loading-overlay').classList.replace('hidden', 'flex'); }
        function updateLoadingText(txt) { document.getElementById('loading-text').innerText = txt; }
        function hideLoading() { document.getElementById('loading-overlay').classList.replace('flex', 'hidden'); }
        lucide.createIcons();
    </script>
</body>
</html>
