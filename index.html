<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì˜¥íŠœë¸Œ - ëª¨ë°”ì¼ ìµœì í™” ì•„ì¹´ì´ë¸Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        
        :root { 
            --primary: #326cf4; 
            --bg-gray: #f8f9fa; 
        }

        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--bg-gray); 
            letter-spacing: -0.025em;
            word-break: keep-all;
        }
        
        /* ì¹´ë“œ ë””ìì¸: ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì ë° ëª¨ë°”ì¼ ìµœì í™” */
        .video-card { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            transition: all 0.3s ease; 
            border: 1px solid rgba(0,0,0,0.04); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        @media (hover: hover) {
            .video-card:hover { 
                transform: translateY(-4px); 
                box-shadow: 0 12px 20px -8px rgba(0, 0, 0, 0.12);
            }
        }
        
        /* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
        .category-btn { 
            transition: all 0.2s; 
            border: 1px solid #eee; 
            background: white; 
            color: #667085;
            flex-shrink: 0;
        }
        .category-btn.active { 
            background-color: var(--primary); 
            color: white; 
            border-color: var(--primary); 
            box-shadow: 0 4px 12px rgba(50, 108, 244, 0.25); 
        }
        
        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .modal-content { 
            animation: modalUp 0.35s cubic-bezier(0.16, 1, 0.3, 1); 
            border-radius: 24px;
        }
        @keyframes modalUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* ëª¨ë°”ì¼ í…ìŠ¤íŠ¸ ìƒëµ ì²˜ë¦¬ */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* í„°ì¹˜ íƒ€ê²Ÿ í¬ê¸° í™•ë³´ */
        button, a { min-height: 44px; display: inline-flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <canvas id="thumb-canvas" class="hidden"></canvas>
    <video id="temp-video" preload="metadata" crossorigin="anonymous" class="hidden"></video>

    <!-- ìƒë‹¨ í—¤ë”: ëª¨ë°”ì¼ ë²„íŠ¼ ê²¹ì¹¨ ë°©ì§€ ìµœì í™” -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 h-14 md:h-18 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                    <i data-lucide="play" fill="currentColor" class="w-3.5 h-3.5 ml-0.5"></i>
                </div>
                <span class="font-black text-lg tracking-tighter">ì˜¥íŠœë¸Œ</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="admin-upload-btn" onclick="toggleUploadModal(true)" class="hidden bg-slate-900 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-black transition-all">
                    ìƒˆ ì˜ìƒ ë“±ë¡
                </button>
                <button id="auth-btn" onclick="handleAuthClick()" class="flex items-center gap-1.5 border border-slate-200 px-3 py-1.5 rounded-full text-slate-600 font-bold text-xs hover:bg-slate-50">
                    <i data-lucide="user" class="w-3 h-3"></i>
                    <span id="auth-btn-text" class="truncate max-w-[60px] md:max-w-none">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 md:py-10">
        <!-- ë©”ì¸ íƒ€ì´í‹€ ëª¨ë°”ì¼ ìµœì í™” -->
        <div class="mb-8 text-center px-2">
            <h1 class="text-2xl md:text-4xl font-black mb-1.5 tracking-tight flex items-center justify-center gap-2">
                <span>ğŸ”¥</span> ì˜¥íŒ¨ì˜ìƒ ì €ì¥ì†Œ <span>ğŸ”¥</span>
            </h1>
            <p class="text-slate-500 text-xs md:text-base font-medium opacity-80">Cloudinary í˜¸ìŠ¤íŒ… ê¸°ë°˜ ì˜êµ¬ ë°ì´í„°ë² ì´ìŠ¤</p>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ & ìƒíƒœ í‘œì‹œ -->
        <div class="flex flex-col gap-4 mb-6">
            <div id="category-container" class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ë Œë”ë§ ì˜ì—­ -->
            </div>
            <div class="flex items-center gap-2 text-[10px] font-bold text-slate-400 bg-white/50 self-start px-3 py-1 rounded-full border border-gray-100">
                <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                <span id="sync-status">ì‹¤ì‹œê°„ í´ë¼ìš°ë“œ ì—°ê²°ë¨</span>
            </div>
        </div>

        <!-- ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ: ëª¨ë°”ì¼ 2ë‹¨(grid-cols-2) ê°•ì œ ì ìš© -->
        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6">
            <div id="initial-loading" class="col-span-full flex flex-col items-center justify-center py-24 gap-4">
                <div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-400 text-xs font-bold tracking-widest uppercase">Syncing Database...</p>
            </div>
        </div>
    </main>

    <!-- ì—…ë¡œë“œ ëª¨ë‹¬ ìµœì í™” -->
    <div id="upload-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] hidden items-center justify-center p-3">
        <div class="bg-white modal-content w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-50">
                <h2 class="text-base font-black text-slate-900">ì˜êµ¬ ì €ì¥ìš© ì˜ìƒ ì—…ë¡œë“œ</h2>
                <button onclick="toggleUploadModal(false)" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="upload-form" class="p-5 space-y-4 overflow-y-auto no-scrollbar">
                <div class="space-y-1.5">
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1">ì œëª©</label>
                    <input required id="video-title" type="text" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm focus:bg-white focus:border-blue-500 outline-none transition-all" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1.5">
                        <label class="text-[11px] font-black text-slate-500 uppercase ml-1">ì¹´í…Œê³ ë¦¬</label>
                        <select id="video-category" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm font-bold">
                            <option value="ë‹¨ê¸°ì»·">ë‹¨ê¸°ì»·</option>
                            <option value="ê³µëµ">ê³µëµ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[11px] font-black text-slate-500 uppercase ml-1">ì‘ì„±ì</label>
                        <input required id="video-author" type="text" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm font-bold" value="GetStar">
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1">íŒŒì¼ ì„ íƒ</label>
                    <input type="file" id="video-file-input" class="hidden" accept="video/*">
                    <div id="upload-dropzone" onclick="document.getElementById('video-file-input').click()" class="border-2 border-dashed border-slate-200 rounded-xl p-6 flex flex-col items-center justify-center gap-2 hover:bg-slate-50 transition-all cursor-pointer">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-slate-300"></i>
                        <p id="dropzone-text" class="text-[11px] text-slate-400 font-bold text-center">í„°ì¹˜í•˜ì—¬ ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                    </div>
                </div>

                <div id="thumb-selection-area" class="space-y-2 hidden">
                    <label class="text-[11px] font-black text-slate-500 uppercase ml-1">ì¸ë„¤ì¼ ì„ íƒ</label>
                    <div id="thumbnail-grid" class="grid grid-cols-5 gap-1.5"></div>
                </div>

                <div class="pt-2 border-t border-gray-50 mt-4">
                    <button id="submit-btn" type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg shadow-blue-100 active:scale-95 transition-all text-sm disabled:bg-slate-300">ë°ì´í„°ë² ì´ìŠ¤ ì˜êµ¬ ì €ì¥</button>
                    <div id="upload-progress-container" class="hidden mt-4">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1 px-1">
                            <span id="progress-text">ì—…ë¡œë“œ ì¤‘...</span>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div id="progress-fill" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- í”Œë ˆì´ì–´ ëª¨ë‹¬ ìµœì í™” -->
    <div id="player-modal" class="fixed inset-0 bg-slate-900/95 z-[200] hidden flex-col items-center justify-center">
        <div class="w-full max-w-4xl bg-black aspect-video relative">
            <button onclick="closePlayer()" class="absolute -top-12 right-0 text-white p-2 flex items-center gap-2 font-bold text-sm">
                ë‹«ê¸° <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div id="video-container" class="w-full h-full"></div>
        </div>
        <div class="w-full max-w-4xl p-6 text-white">
            <span id="playing-category" class="text-blue-400 text-[10px] font-black uppercase tracking-widest"></span>
            <h2 id="playing-title" class="text-lg font-bold mt-1 line-clamp-2"></h2>
            <button onclick="closePlayer()" class="mt-6 w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm transition-all">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] hidden items-center justify-center p-6">
        <div class="bg-white modal-content w-full max-w-xs p-6 shadow-2xl text-center">
            <h2 class="text-lg font-black mb-6">ADMIN AUTH</h2>
            <form id="login-form" class="space-y-4">
                <input required id="login-password" type="password" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-center text-xl tracking-widest focus:bg-white outline-none" placeholder="â€¢â€¢â€¢â€¢">
                <div id="login-error" class="text-red-500 text-[10px] font-bold hidden">ì¸ì¦ ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤</div>
                <button type="submit" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm">ë¡œê·¸ì¸</button>
                <button type="button" onclick="toggleLoginModal(false)" class="text-slate-400 text-xs font-bold pt-2">ì·¨ì†Œ</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'octopath-85851';
        const ADMIN_EMAIL = "tjsgoehd@gmail.com";
        const CLOUD_NAME = "dhytg4nc1";
        const UPLOAD_PRESET = "octopath_media";

        let currentUser = null;
        let allVideos = [];
        let currentCategory = 'ì „ì²´';
        let unsubscribe = null;
        let selectedThumbBase64 = '';
        let selectedVideoFile = null;

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (!user) { await signInAnonymously(auth); return; }
            const isAdmin = !user.isAnonymous && user.email === ADMIN_EMAIL;
            document.getElementById('admin-upload-btn')?.classList.toggle('hidden', !isAdmin);
            document.getElementById('auth-btn-text').innerText = isAdmin ? "ADMIN" : "ê´€ë¦¬ì";
            if (unsubscribe) unsubscribe();
            startDataListener();
            lucide.createIcons();
        });

        function startDataListener() {
            const videoRef = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
            unsubscribe = onSnapshot(videoRef, (snapshot) => {
                allVideos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allVideos.sort((a, b) => (b.createdAt?.toMillis() || Date.now()) - (a.createdAt?.toMillis() || Date.now()));
                document.getElementById('initial-loading')?.classList.add('hidden');
                renderVideos();
            });
        }

        window.renderVideos = () => {
            const grid = document.getElementById('video-grid');
            const filtered = currentCategory === 'ì „ì²´' ? allVideos : allVideos.filter(v => v.category === currentCategory);
            
            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-300 font-bold text-sm italic">ë“±ë¡ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(v => `
                <div class="video-card group active:scale-95" onclick="playVideo('${v.url}', '${v.title}', '${v.category}')">
                    <div class="aspect-video relative bg-slate-200">
                        <img src="${v.thumbnail}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-blue-600/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i data-lucide="play" class="text-white w-8 h-8 drop-shadow-lg"></i>
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="text-[9px] font-black text-blue-600 mb-1 uppercase tracking-widest">${v.category}</div>
                        <h3 class="font-bold text-slate-900 text-xs md:text-sm line-clamp-2 h-8 md:h-10 leading-snug">${v.title}</h3>
                        <div class="mt-2 pt-2 border-t border-gray-50 flex items-center gap-1.5 text-[10px] text-slate-400 font-bold">
                            <div class="w-4 h-4 rounded-full bg-slate-100 flex items-center justify-center"><i data-lucide="user" class="w-2.5 h-2.5"></i></div>
                            <span class="truncate">${v.author}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        // ì—…ë¡œë“œ ë° ê¸°íƒ€ ë¡œì§
        const videoInput = document.getElementById('video-file-input');
        videoInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedVideoFile = file;
            document.getElementById('dropzone-text').innerText = "ë¶„ì„ ì¤‘: " + file.name;
            const videoUrl = URL.createObjectURL(file);
            const video = document.getElementById('temp-video');
            video.src = videoUrl;
            video.onloadedmetadata = async () => {
                const thumbGrid = document.getElementById('thumbnail-grid');
                thumbGrid.innerHTML = "";
                const timePoints = [0.1, video.duration * 0.5, video.duration * 0.9];
                for (let i = 0; i < timePoints.length; i++) {
                    video.currentTime = timePoints[i];
                    await new Promise(r => video.onseeked = r);
                    const canvas = document.getElementById('thumb-canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.5);
                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = `border-2 rounded-lg overflow-hidden cursor-pointer aspect-video ${i === 1 ? 'border-blue-500' : 'border-transparent'}`;
                    if(i === 1) selectedThumbBase64 = base64;
                    thumbDiv.innerHTML = `<img src="${base64}" class="w-full h-full object-cover">`;
                    thumbDiv.onclick = () => {
                        document.querySelectorAll('#thumbnail-grid div').forEach(el => el.classList.remove('border-blue-500'));
                        thumbDiv.classList.add('border-blue-500'); selectedThumbBase64 = base64;
                    };
                    thumbGrid.appendChild(thumbDiv);
                }
                document.getElementById('thumb-selection-area').classList.remove('hidden');
                document.getElementById('dropzone-text').innerText = "íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ: " + file.name;
            };
        });

        document.getElementById('upload-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!selectedVideoFile) return;
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            document.getElementById('upload-progress-container').classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append("file", selectedVideoFile);
                formData.append("upload_preset", UPLOAD_PRESET);
                
                const xhr = new XMLHttpRequest();
                xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, true);
                
                const json = await new Promise((resolve, reject) => {
                    xhr.upload.onprogress = (ev) => {
                        if (ev.lengthComputable) {
                            const per = Math.round((ev.loaded / ev.total) * 90);
                            document.getElementById('progress-fill').style.width = per + "%";
                            document.getElementById('progress-percent').innerText = per + "%";
                        }
                    };
                    xhr.onload = () => xhr.status < 300 ? resolve(JSON.parse(xhr.responseText)) : reject();
                    xhr.onerror = reject;
                    xhr.send(formData);
                });

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), {
                    title: document.getElementById('video-title').value,
                    author: document.getElementById('video-author').value,
                    category: document.getElementById('video-category').value,
                    url: json.secure_url, 
                    thumbnail: selectedThumbBase64, 
                    createdAt: serverTimestamp()
                });
                
                toggleUploadModal(false);
                location.reload();
            } catch (err) {
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
                btn.disabled = false;
            }
        };

        window.toggleUploadModal = (s) => document.getElementById('upload-modal').classList.toggle('hidden', !s);
        window.toggleLoginModal = (s) => document.getElementById('login-modal').classList.toggle('hidden', !s);
        window.handleAuthClick = () => currentUser && !currentUser.isAnonymous ? signOut(auth).then(()=>location.reload()) : toggleLoginModal(true);
        
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            try { 
                await signInWithEmailAndPassword(auth, ADMIN_EMAIL, document.getElementById('login-password').value); 
                toggleLoginModal(false); 
            } catch { 
                document.getElementById('login-error').classList.remove('hidden'); 
            }
        };

        window.playVideo = (u, t, c) => {
            document.getElementById('video-container').innerHTML = `<video src="${u}" controls autoplay class="w-full h-full"></video>`;
            document.getElementById('playing-title').innerText = t;
            document.getElementById('playing-category').innerText = c;
            document.getElementById('player-modal').classList.remove('hidden');
            document.getElementById('player-modal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        };
        window.closePlayer = () => { 
            document.getElementById('video-container').innerHTML = ""; 
            document.getElementById('player-modal').classList.add('hidden'); 
            document.body.style.overflow = 'auto'; 
        };
        
        window.filterByCategory = (cat) => { currentCategory = cat; renderCategories(); renderVideos(); };
        function renderCategories() {
            const cats = ['ì „ì²´', 'ë‹¨ê¸°ì»·', 'ê³µëµ', 'ê¸°íƒ€'];
            document.getElementById('category-container').innerHTML = cats.map(cat => `
                <button onclick="filterByCategory('${cat}')" class="category-btn px-5 py-2 rounded-full text-xs font-black ${currentCategory === cat ? 'active' : ''}">
                    ${cat}
                </button>
            `).join('');
        }
        renderCategories();
    </script>
</body>
</html>
