<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>옥튜브 - 아카이브</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; letter-spacing: -0.025em; }
        
        .video-card { background: white; border-radius: 16px; overflow: hidden; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); cursor: pointer; border: 1px solid #f1f5f9; position: relative; }
        .video-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: #e2e8f0; }
        
        .author-badge {
            position: absolute; top: 10px; left: 10px; background-color: #ff5a5a; color: white;
            padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 700; z-index: 10; box-shadow: 0 4px 8px rgba(255, 90, 90, 0.3);
        }

        .category-text { color: #2563eb; font-size: 11px; font-weight: 700; margin-bottom: 2px; display: inline-block; }
        .video-title { font-size: 1rem; font-weight: 800; color: #0f172a; line-height: 1.3; }

        .filter-btn { transition: all 0.2s; background: white; color: #64748b; border: 1px solid #f1f5f9; }
        .filter-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }

        #player-modal { backdrop-filter: blur(20px); background-color: rgba(0, 0, 0, 0.9); }
        
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }

        /* 무한 로딩 방지 및 상단 버튼 차단 마스크 */
        .player-wrapper { position: relative; width: 100%; height: 100%; }
        .click-mask {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 50;
            background: transparent;
            cursor: default;
        }
        body.is-admin .click-mask { display: none; }
    </style>
</head>
<body class="text-slate-900">

    <header class="sticky top-0 z-[100] bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2.5 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                    <i data-lucide="play" fill="white" class="w-4 h-4 ml-0.5"></i>
                </div>
                <span class="font-extrabold text-xl tracking-tighter">옥튜브</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="handleLogout()" class="admin-only bg-rose-50 text-rose-600 px-3 py-2 rounded-full text-[11px] font-bold border border-rose-100">로그아웃</button>
                <button id="login-btn" onclick="initGoogleAuth()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold">관리자 로그인</button>
                <button onclick="alert('영상 등록 기능을 실행합니다.')" class="admin-only bg-blue-600 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-lg">영상 등록</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="category-filters" class="flex gap-2 overflow-x-auto pb-6 mb-4">
            <button onclick="filterVideos('전체')" class="filter-btn active px-6 py-2 rounded-full text-sm font-bold">전체</button>
            <button onclick="filterVideos('단기컷')" class="filter-btn px-6 py-2 rounded-full text-sm font-bold">단기컷</button>
            <button onclick="filterVideos('공략')" class="filter-btn px-6 py-2 rounded-full text-sm font-bold">공략</button>
        </div>
        <div id="video-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
    </main>

    <!-- 플레이어 모달 -->
    <div id="player-modal" class="fixed inset-0 z-[1000] hidden flex-col items-center justify-center p-4" onclick="closePlayer()">
        <div class="w-full max-w-5xl" onclick="event.stopPropagation()">
            <div class="bg-black rounded-[24px] overflow-hidden aspect-video shadow-2xl relative player-wrapper">
                <!-- 상단 우측 버튼 차단 마스크 -->
                <div class="click-mask"></div>
                <div id="video-iframe-container" class="w-full h-full"></div>
            </div>
            <div class="mt-6 flex justify-center gap-3">
                <button onclick="closePlayer()" class="text-white bg-white/10 px-8 py-3 rounded-full font-bold backdrop-blur-md hover:bg-white/20 transition-all">닫기</button>
                <button id="direct-view-btn" class="admin-only text-blue-400 bg-blue-400/10 px-8 py-3 rounded-full font-bold backdrop-blur-md">새 탭에서 열기 (관리자)</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const targetCollection = collection(db, 'artifacts', 'octopath-85851', 'public', 'data', 'videos');

        let allVideos = [];

        window.onload = async () => {
            await signInAnonymously(auth);
            loadVideos();
            if(sessionStorage.getItem('drive_token')) {
                document.body.classList.add('is-admin');
                document.getElementById('login-btn').style.display = 'none';
            }
            lucide.createIcons();
        };

        function loadVideos() {
            onSnapshot(targetCollection, (snap) => {
                allVideos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                    .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderVideos();
            });
        }

        window.renderVideos = () => {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = allVideos.map(v => `
                <div class="video-card" onclick="openPlayer('${v.fileId}')">
                    <div class="aspect-video bg-slate-100 relative">
                        <div class="author-badge">
                            <i data-lucide="user" class="w-3 h-3"></i>
                            <span>${v.author || '익명'}</span>
                        </div>
                        <img src="${v.thumbnail}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <span class="category-text">${v.category}</span>
                        <h3 class="video-title line-clamp-2">${v.title}</h3>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.openPlayer = (fileId) => {
            const container = document.getElementById('video-iframe-container');
            const directBtn = document.getElementById('direct-view-btn');
            
            // 안정적인 기본 프리뷰 URL 사용 (무한로딩 방지)
            container.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" class="w-full h-full" allow="autoplay"></iframe>`;
            
            directBtn.onclick = () => window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
            document.getElementById('player-modal').classList.replace('hidden', 'flex');
        };

        window.closePlayer = () => {
            document.getElementById('video-iframe-container').innerHTML = '';
            document.getElementById('player-modal').classList.replace('flex', 'hidden');
        };

        window.handleLogout = () => {
            sessionStorage.removeItem('drive_token');
            location.reload();
        };

        window.initGoogleAuth = () => {
            sessionStorage.setItem('drive_token', 'active');
            location.reload();
        };

        window.filterVideos = (cat) => {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.toggle('active', btn.innerText === cat));
            // 실제 필터링 로직 추가 가능
        };
    </script>
</body>
</html>
