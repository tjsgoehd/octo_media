<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OKTUBE | í”„ë¦¬ë¯¸ì—„ ë¹„ë””ì˜¤ ê³µìœ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #f8fafc; 
            letter-spacing: -0.025em; 
        }

        .glass-header { 
            backdrop-filter: blur(20px); 
            background: rgba(255, 255, 255, 0.9); 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
        }

        /* ë‹‰ë„¤ì„ ë°°ì§€ ìƒ‰ìƒ (ì´ë¯¸ì§€ ì°¸ê³ : ë¶‰ì€/ì½”ë„ ê³„ì—´) */
        .author-badge {
            background-color: #ff5e5e; /* ìš”ì²­í•˜ì‹  ë¶‰ì€ìƒ‰ ê³„ì—´ */
            color: white;
        }

        .video-card {
            transition: all 0.3s ease;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .cat-btn.active {
            background-color: #2563eb;
            color: white;
        }

        .thumbnail-option {
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .thumbnail-option.selected {
            border-color: #2563eb;
            transform: scale(1.05);
        }

        /* ëª¨ë°”ì¼ í„°ì¹˜ ëŒ€ì‘ */
        @media (max-width: 640px) {
            .video-grid {
                grid-template-columns: repeat(2, 1fr) !important; /* ê°€ë¡œ 2ê°œ ë…¸ì¶œ */
                gap: 12px !important;
            }
            .video-card-content {
                padding: 10px !important;
            }
            .video-title {
                font-size: 13px !important;
            }
            .video-cat {
                font-size: 11px !important;
            }
        }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <!-- Header -->
    <header class="sticky top-0 z-[60] glass-header px-4 md:px-12 h-16 md:h-20 flex items-center justify-between">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-lg md:rounded-xl flex items-center justify-center text-white shadow-lg">
                <i data-lucide="play" fill="currentColor" class="w-4 h-4 md:w-5 md:h-5 ml-0.5"></i>
            </div>
            <span class="font-bold text-lg md:text-xl tracking-tight">ì˜¥íŠœë¸Œ</span>
        </div>
        
        <div class="flex items-center gap-2 md:gap-3">
            <button id="upload-btn" onclick="openUploadModal()" class="hidden items-center gap-1.5 bg-slate-900 text-white px-4 py-2 rounded-full text-xs md:text-sm font-semibold shadow-md hover:bg-slate-800 transition-all">
                <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                <span>ë“±ë¡</span>
            </button>
            <button id="auth-btn" onclick="handleAuth()" class="flex items-center gap-1.5 border border-slate-200 bg-white text-slate-600 px-4 py-2 rounded-full text-xs md:text-sm font-semibold hover:bg-slate-50 transition-all">
                <i data-lucide="user" class="w-3.5 h-3.5"></i>
                <span id="auth-text">ADMIN</span>
            </button>
        </div>
    </header>

    <main class="max-w-[1400px] mx-auto px-4 md:px-12 py-6 md:py-10">
        <section class="mb-6 md:mb-10">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-xl md:text-2xl">ğŸ”¥</span>
                <h1 class="text-xl md:text-3xl font-extrabold tracking-tight">ì§€ê¸ˆ ê°€ì¥ í•«í•œ ì½˜í…ì¸ </h1>
            </div>
            <p class="text-slate-500 text-xs md:text-base">ì•„ì¹´ì´ë¸Œì˜ ìµœì‹  ì˜ìƒì„ í™•ì¸í•˜ì„¸ìš”.</p>
        </section>

        <nav class="flex gap-2 overflow-x-auto pb-6 mb-2 no-scrollbar">
            <button onclick="filterCat('ì „ì²´')" class="cat-btn active whitespace-nowrap px-5 py-2 rounded-full text-xs md:text-sm font-bold bg-white text-slate-600 border border-slate-100 shadow-sm transition-all">ì „ì²´</button>
            <button onclick="filterCat('ë‹¨ê¸°ì»·')" class="cat-btn whitespace-nowrap px-5 py-2 rounded-full text-xs md:text-sm font-bold bg-white text-slate-500 border border-slate-100 shadow-sm transition-all">ë‹¨ê¸°ì»·</button>
            <button onclick="filterCat('ê³µëµ')" class="cat-btn whitespace-nowrap px-5 py-2 rounded-full text-xs md:text-sm font-bold bg-white text-slate-500 border border-slate-100 shadow-sm transition-all">ê³µëµ</button>
            <button onclick="filterCat('ê¸°íƒ€')" class="cat-btn whitespace-nowrap px-5 py-2 rounded-full text-xs md:text-sm font-bold bg-white text-slate-500 border border-slate-100 shadow-sm transition-all">ê¸°íƒ€</button>
        </nav>

        <!-- Video Grid: ëª¨ë°”ì¼ ê°€ë¡œ 2ê°œ ë³´ì¥ -->
        <div id="video-grid" class="video-grid grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-x-6 md:gap-y-10">
            <div class="col-span-full py-40 flex flex-col items-center justify-center text-slate-300">
                <div class="loader mb-6 border-4 border-slate-100 border-t-blue-500 rounded-full w-10 h-10 animate-spin"></div>
                <p class="font-medium">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>
    </main>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-slate-900/60 backdrop-blur-md p-4 overflow-y-auto">
        <div class="bg-white w-full max-w-2xl rounded-[1.5rem] md:rounded-[2.5rem] p-6 md:p-10 shadow-2xl relative my-auto">
            <div id="progress-overlay" class="absolute inset-0 z-50 bg-white/95 hidden flex-col justify-center items-center px-10 text-center rounded-[2.5rem]">
                <div class="loader mb-4 border-4 border-slate-100 border-t-blue-500 rounded-full w-10 h-10 animate-spin"></div>
                <h3 class="text-lg font-bold text-slate-900" id="progress-text">ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...</h3>
            </div>
            
            <div class="flex items-center justify-between mb-6 md:mb-8">
                <h2 class="text-lg md:text-xl font-bold">ìƒˆ ì˜ìƒ ë“±ë¡</h2>
                <button onclick="closeUploadModal()" class="w-8 h-8 hover:bg-slate-100 rounded-full flex items-center justify-center transition-all">
                    <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>

            <div class="space-y-4 md:space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[11px] font-bold text-slate-400 ml-1">ì˜ìƒ ì œëª©</label>
                        <input id="v-title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full bg-slate-50 border border-slate-100 p-3.5 md:p-4 rounded-xl md:rounded-2xl font-medium focus:border-blue-500 outline-none transition-all">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[11px] font-bold text-slate-400 ml-1">ë¶„ë¥˜</label>
                            <select id="v-category" class="w-full bg-slate-50 border border-slate-100 p-3.5 md:p-4 rounded-xl md:rounded-2xl font-medium outline-none">
                                <option value="ë‹¨ê¸°ì»·">ë‹¨ê¸°ì»·</option>
                                <option value="ê³µëµ">ê³µëµ</option>
                                <option value="ê¸°íƒ€" selected>ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-bold text-slate-400 ml-1">ì‘ì„±ì</label>
                            <input id="v-author" type="text" placeholder="ë‹‰ë„¤ì„" class="w-full bg-slate-50 border border-slate-100 p-3.5 md:p-4 rounded-xl md:rounded-2xl font-medium outline-none">
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[11px] font-bold text-slate-400 ml-1">ì˜ìƒ íŒŒì¼</label>
                    <input type="file" id="v-file" accept="video/*" class="hidden">
                    <div onclick="document.getElementById('v-file').click()" class="border-2 border-dashed border-slate-100 rounded-2xl p-6 md:p-8 text-center cursor-pointer hover:bg-blue-50/50 hover:border-blue-200 transition-all group">
                        <p id="file-label" class="text-sm font-bold text-slate-400 group-hover:text-blue-600">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>

                <div id="thumbnail-section" class="space-y-3 hidden">
                    <label class="text-[11px] font-bold text-slate-400 ml-1">ì¸ë„¤ì¼ ì„ íƒ (ìë™ ì¶”ì¶œë¨)</label>
                    <div id="thumbnail-preview-grid" class="grid grid-cols-5 gap-2"></div>
                </div>

                <button onclick="handleDriveUpload()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:bg-blue-700 active:scale-[0.98] transition-all">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-[200] hidden items-center justify-center bg-slate-900/60 backdrop-blur-md p-4">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-sm text-center shadow-2xl">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="shield-check" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <input id="login-pw" type="password" class="w-full bg-slate-50 border border-slate-100 p-4 rounded-2xl mb-4 text-center tracking-[0.5em] font-black focus:border-blue-500 outline-none transition-all" placeholder="â€¢â€¢â€¢â€¢" onkeypress="if(event.keyCode==13) performLogin()">
            <button onclick="performLogin()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition-all">í™•ì¸</button>
            <button onclick="closeLoginModal()" class="w-full py-2 text-slate-400 mt-4 text-sm font-medium hover:text-slate-600">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="player-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-slate-950/90 backdrop-blur-sm p-4" onclick="if(event.target === this) closePlayer()">
        <div id="player-content" class="w-full max-w-5xl bg-black rounded-[1.5rem] md:rounded-[2rem] overflow-hidden shadow-2xl relative scale-95 opacity-0 transition-all duration-300">
            <button onclick="closePlayer()" class="absolute top-3 right-3 z-10 w-10 h-10 bg-black/40 backdrop-blur-md text-white rounded-full flex items-center justify-center transition-all">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div class="w-full aspect-video bg-black">
                <iframe id="main-iframe-player" class="w-full h-full" src="" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const CLIENT_ID = '131660349524-lfu2c56t4ent6167fu68essbleoquptp.apps.googleusercontent.com';
        const FOLDER_ID = '12WN0Y1v5MhetMRAUEBFOOAR2NA5PWsJa';
        const ADMIN_EMAIL = 'tjsgoehd@gmail.com';
        const firebaseConfig = {
            apiKey: "AIzaSyAjbApqAPhrZXcnR2P_xd-nvrZOvZp67CI",
            authDomain: "octopath-85851.firebaseapp.com",
            projectId: "octopath-85851",
            storageBucket: "octopath-85851.firebasestorage.app",
            messagingSenderId: "744016190979",
            appId: "1:744016190979:web:fbc5badeda2e24f5f47836",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.allVideos = [];
        let currentCategory = 'ì „ì²´';
        let isAdmin = false;
        let tokenClient;
        let accessToken = null;
        let selectedThumbnailBase64 = null;

        window.onload = () => {
            if (typeof google !== 'undefined') {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.access_token) {
                            accessToken = response.access_token;
                            performDriveUpload();
                        }
                    },
                });
            }
            
            onAuthStateChanged(auth, (user) => {
                isAdmin = (user && user.email === ADMIN_EMAIL);
                document.getElementById('upload-btn').classList.toggle('hidden', !isAdmin);
                document.getElementById('auth-text').innerText = isAdmin ? "LOGOUT" : "ADMIN";
                fetchVideos();
            });

            if(!auth.currentUser) signInAnonymously(auth);
            lucide.createIcons();
        };

        function fetchVideos() {
            const vRef = collection(db, 'artifacts', 'oktube-drive-v1', 'public', 'data', 'videos');
            onSnapshot(vRef, (snap) => {
                window.allVideos = snap.docs.map(doc => ({id: doc.id, ...doc.data()}))
                                .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            });
        }

        function render() {
            const grid = document.getElementById('video-grid');
            const videos = window.allVideos || [];
            const filtered = currentCategory === 'ì „ì²´' ? videos : videos.filter(v => v.category === currentCategory);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-40 text-center text-slate-300 font-bold">ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            grid.innerHTML = filtered.map(v => `
                <div class="video-card bg-white rounded-2xl md:rounded-3xl overflow-hidden shadow-sm border border-slate-100 cursor-pointer" onclick="window.openPlayer('${v.url}')">
                    <div class="aspect-video bg-slate-100 relative overflow-hidden">
                        <img src="${v.thumbnail || ''}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                            <i data-lucide="play" fill="white" class="w-8 h-8 text-white"></i>
                        </div>
                        <!-- ë‹‰ë„¤ì„ ë°°ì§€ ë””ìì¸ ë³€ê²½: ìƒ‰ìƒ ë° ì•„ì´ì½˜ ì¶”ê°€ -->
                        <div class="absolute top-2 left-2 md:top-3 md:left-3 author-badge flex items-center gap-1 px-2 py-0.5 md:px-3 md:py-1 rounded-full shadow-md">
                            <i data-lucide="user" class="w-2.5 h-2.5 md:w-3 md:h-3 text-white" fill="currentColor"></i>
                            <span class="text-[9px] md:text-[11px] font-bold">${v.author}</span>
                        </div>
                    </div>
                    <div class="video-card-content p-3 md:p-5">
                        <!-- ì¹´í…Œê³ ë¦¬ ì˜ì—­ (ê°•ì¡°ìƒ‰) -->
                        <p class="video-cat text-blue-600 text-[10px] md:text-[12px] font-bold mb-1">${v.category}</p>
                        <!-- ì œëª© ì˜ì—­ -->
                        <h3 class="video-title font-bold text-slate-800 text-sm md:text-base line-clamp-1">${v.title}</h3>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function extractThumbnails(file) {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playsInline = true;

            return new Promise((resolve) => {
                video.onloadedmetadata = async () => {
                    const duration = video.duration;
                    const grid = document.getElementById('thumbnail-preview-grid');
                    grid.innerHTML = '';
                    const times = Array.from({length: 5}, () => Math.random() * duration);
                    
                    for(let i=0; i < times.length; i++) {
                        video.currentTime = times[i];
                        await new Promise(r => video.onseeked = r);
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = 640; canvas.height = 360;
                        canvas.getContext('2d').drawImage(video, 0, 0, 640, 360);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        const imgDiv = document.createElement('div');
                        imgDiv.className = `thumbnail-option aspect-video rounded-lg overflow-hidden cursor-pointer bg-slate-200 ${i === 0 ? 'selected' : ''}`;
                        if(i === 0) selectedThumbnailBase64 = dataUrl;
                        
                        imgDiv.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
                        imgDiv.onclick = () => {
                            document.querySelectorAll('.thumbnail-option').forEach(el => el.classList.remove('selected'));
                            imgDiv.classList.add('selected');
                            selectedThumbnailBase64 = dataUrl;
                        };
                        grid.appendChild(imgDiv);
                    }
                    resolve();
                };
            });
        }

        window.handleDriveUpload = () => {
            const file = document.getElementById('v-file').files[0];
            if(!file || !selectedThumbnailBase64) return alert("í•„ìˆ˜ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.");
            document.getElementById('progress-overlay').classList.remove('hidden');
            if (tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' });
        };

        async function performDriveUpload() {
            const file = document.getElementById('v-file').files[0];
            const title = document.getElementById('v-title').value || "ì œëª© ì—†ìŒ";
            const author = document.getElementById('v-author').value || "ê´€ë¦¬ì";
            const category = document.getElementById('v-category').value;
            const statusText = document.getElementById('progress-text');

            try {
                const metadata = { name: file.name, parents: [FOLDER_ID] };
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);

                const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                    body: formData
                });
                const fileData = await res.json();
                
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileData.id}/permissions`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'viewer', type: 'anyone' })
                });

                await addDoc(collection(db, 'artifacts', 'oktube-drive-v1', 'public', 'data', 'videos'), {
                    title, author, category,
                    url: `https://drive.google.com/file/d/${fileData.id}/preview`,
                    thumbnail: selectedThumbnailBase64,
                    createdAt: serverTimestamp()
                });

                location.reload();
            } catch (err) {
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + err.message);
                document.getElementById('progress-overlay').classList.add('hidden');
            }
        }

        window.openPlayer = (url) => {
            const modal = document.getElementById('player-modal');
            const content = document.getElementById('player-content');
            const iframe = document.getElementById('main-iframe-player');
            const autoPlayUrl = url.includes('?') ? `${url}&autoplay=1` : `${url}?autoplay=1`;
            
            iframe.src = autoPlayUrl;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => content.classList.replace('scale-95', 'scale-100'), 50);
            setTimeout(() => content.classList.replace('opacity-0', 'opacity-100'), 50);
            document.body.style.overflow = 'hidden';
        };

        window.closePlayer = () => {
            const modal = document.getElementById('player-modal');
            const content = document.getElementById('player-content');
            content.classList.replace('scale-100', 'scale-95');
            content.classList.replace('opacity-100', 'opacity-0');
            setTimeout(() => {
                document.getElementById('main-iframe-player').src = "";
                modal.classList.replace('flex', 'hidden');
                document.body.style.overflow = '';
            }, 300);
        };

        window.filterCat = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.innerText === cat));
            render();
        };

        window.handleAuth = () => isAdmin ? signOut(auth).then(()=>location.reload()) : document.getElementById('login-modal').classList.remove('hidden');
        window.performLogin = async () => {
            const pw = document.getElementById('login-pw').value;
            try { await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pw); document.getElementById('login-modal').classList.add('hidden'); } catch { alert("ì¸ì¦ ì‹¤íŒ¨"); }
        };

        window.openUploadModal = () => document.getElementById('upload-modal').classList.remove('hidden');
        window.closeUploadModal = () => document.getElementById('upload-modal').classList.add('hidden');
        window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');

        document.getElementById('v-file').onchange = async (e) => {
            const file = e.target.files[0];
            if(file) {
                document.getElementById('file-label').innerText = file.name;
                document.getElementById('thumbnail-section').classList.remove('hidden');
                await extractThumbnails(file);
            }
        };
    </script>
</body>
</html>
